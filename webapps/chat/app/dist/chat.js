/* 
 * @packet chat;
 * @template template.chatemp;
 * @require service.chat;
 * @css style.chatyle;
 */
Module({name:"chatlogin",extend:"view",className:"chatlogin",template:module.getTemplate("@chatemp","chatlogin"),services:{chat:"@chat.chatservice"},init:function(){this.render()},find_login:function(t){t.click(function(){var t=this.finders("input").val();t?this.getService("chat").trigger("login",t):$.toast("username can not empty.")}.bind(this))},service_loginend:function(t){this.out().done(function(){this.dispatchEvent("loginend",t)}.bind(this))},out:function(){var t=this.dom.transition().all();return t.scope().css("opacity",0),t}}),Module({name:"chatcontainer",extend:"viewgroup",className:"chatcontainer",layout:module.getTemplate("@chatemp","chatcontainer"),services:{chat:"@chat.chatservice"},option:{chatlistType:"@.chatlist",id:"",onlines:[]},onbeforeinit:function(){this.option[this.option.chatlistType]={onlines:this.option.onlines}},init:function(){this.boxs={},this.currentbox=null},service_message:function(t){t.type&&"offline"!==t.type?this.dispatchEvent("message",t):"offline"!==t.type&&$.toast("You are offline!")},event_message:function(t){var i=t.data.type;this["comet_"+i]&&this["comet_"+i](t.data)},event_openbox:function(t){var i=t.data;if(this.currentbox=i.id,this.boxs[i.id]){for(var e in this.boxs)this.boxs[e].hide();this.boxs[i.id].show()}else this.boxs[i.id]="in",this.addChild({type:"@.chatbox",option:{id:this.option.id,info:i},container:this.finders("boxcontainer")}).done(function(t){this.boxs[i.id]=t})},event_sendmsg:function(t){this.getService("chat").trigger("write",{to:t.data.info.id,msg:t.data.msg})},comet_userlogin:function(t){this.getFirstChild().add(t.id)},comet_userlogout:function(t){this.getFirstChild().remove(t.id)},comet_message:function(t){var i=t;this.boxs[i.id]?(this.boxs[i.id].addMessage(i),this.currentbox!==i.id&&this.getFirstChild().setstate(i)):(this.boxs[i.id]="in",this.addChild({type:"@.chatbox",option:{id:this.option.id,info:{id:i.id}},container:this.finders("boxcontainer")}).done(function(t){this.boxs[i.id]=t,null!==this.currentbox&&this.currentbox!==i.id&&t.hide(),t.addMessage(i)}))}}),Module({name:"chatbox",extend:"view",className:"chatbox",autodom:!0,option:{id:"",info:null},template:module.getTemplate("@chatemp","chatbox"),services:{box:"@chat.chatboxservice"},init:function(){this.getService("box").action("set",{id:this.option.id,info:this.option.info,message:[]}),this.render(this.getService("box").action("get"))},find_send:function(t){var i=this;t.click(function(){var t=i.finders("input").val();t?(i.dispatchEvent("sendmsg",{info:i.option.info,msg:t}),i.addMessage({id:i.option.id,msg:t})):$.toast("Message can not empty!")})},hide:function(){this.dom.hide()},show:function(){this.dom.show()},addMessage:function(t){this.getService("box").trigger("add",t),this.finders("messbox").scrollTop(1e10)}}),Module({name:"chatlist",extend:"view",className:"chatlist",autodom:!0,option:{onlines:[]},template:module.getTemplate("@chatemp","chatlist"),services:{chatlist:"@chat.chatlistservice"},init:function(){this.getService("chatlist").action("set",this.option.onlines),this.render(this.option.onlines)},find_item:function(t){var i=this;t.click(function(){var t=$(this).cache();i.getChatList().trigger("unstate",t.id),i.dispatchEvent("openbox",t)})},add:function(t){this.getChatList().trigger("add",{id:t}),$.toast("user "+t+" login now.")},remove:function(t){this.getChatList().trigger("remove",t),$.toast("user "+t+" logout now.")},setstate:function(t){this.getChatList().trigger("state",t.id)},getChatList:function(){return this.getService("chatlist")}}),$.toast=function(t){$("<div class='toast'><div class='toast_text'>"+t+"</div></div>").appendTo("body").transition().set("-all-transform").done(function(){this.transition().removeAll().set("opacity",{time:1e3}).delay(2e3).then(function(){this.css("opacity",0)}).delay(1e3).done(function(){this.remove()}).resolve()}).scope().transform().y(-150)},$.loadingbar=function(){var t=$("#loadingbar");return 0===t.length&&(t=$("<div id='loadingbar'><div class='loadingbar-bg'></div><div class='loadingbar-desc'></div></div>").appendTo("body")),new loadingbar(t)};var loadingbar=function(t){this.dom=t};loadingbar.prototype.showLoading=function(t){return this.dom.children(1).html("<i class='fa fa-repeat fa-spin'></i> "+(t||"Loading...")),this},loadingbar.prototype.showError=function(t){var i=$.promise(),e=this;return setTimeout(function(){e.close(),i.resolve()},2e3),this.dom.children(1).html("<i class='fa fa-circle-cross'></i> "+(t||"操作错误")),i},loadingbar.prototype.showSuccess=function(t){var i=$.promise(),e=this;return setTimeout(function(){e.close(),i.resolve()},2e3),this.dom.children(1).html("<i class='fa fa-circle-check'></i> "+(t||"操作成功")),i},loadingbar.prototype.close=function(){this.dom.remove()};